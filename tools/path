#!/bin/sh

# SPDX-FileCopyrightText: 2021 - 2023 Mewbot Developers <mewbot@quicksilver.london>
#
# SPDX-License-Identifier: BSD-2-Clause

auto_detect_python()
{
  # Detect a binary called 'python3'
  # We automatically assume this has a valid version.
  if PYTHON=$(command -v python3 2>/dev/null)
  then
    printf "%s" "$PYTHON"
    return 0
  fi

  # Detect a binary called 'python'
  if ! PYTHON=$(command -v python 2>/dev/null)
  then
    return 1
  fi

  # Confirm it is actually a python binary
  if ! VERSION=$("$PYTHON" --version) || ! [ "$VERSION" != "${VERSION#Python }" ]
  then
    return 1
  fi

  # Extract the major version number
  VERSION=${VERSION#Python }
  MAJOR=${VERSION%%.*}

  if [ "$MAJOR" -ne 3 ]
  then
    return 1
  fi

  printf "%s" "$PYTHON"
}

# Detect python binary if not set in the environment.
if [ -z "$PYTHON" ]
then
  if ! PYTHON=$(auto_detect_python)
  then
    printf >&2 "Unable to locate a python v3 interpreter as either 'python3' or 'python'\n"
    printf >&2 "Make sure python is installed. If it is not on your PATH, you can specify a location with the PYTHON environment variable.\n"
    exit 1
  fi

  printf >&2 "Selecting %s as python interpreter\n" "$PYTHON"
fi

readonly PYTHON

PYTHONPATH="$("$PYTHON" src/mewbot/tools/path.py)"

readonly PYTHONPATH
export PYTHONPATH
